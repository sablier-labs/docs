---
id: "flow-calculate-rps"
sidebar_position: 2
title: "Calculate Rate per Second"
---

import CodeBlock from "@theme/CodeBlock";
import CautionNonProduction from "../../../../src/snippets/_caution-non-production.mdx";

This guide explains how to calculate the rate per second when creating a Flow stream. It is the most important step in
setting up a stream since the rate per second is a key parameter in the stream's configuration.

We assume that you have already gone through the [Protocol Concepts](/concepts/streaming) and the
[Flow Overview](/concepts/flow/overview) sections.

<CautionNonProduction />

The rate per second is the amount of tokens streamed in one second. It is represented as a fixed-point number with 18
decimals, specifically as a `UD21x18` type from the `PRBMath` library. The underlying native Solidity type associated
with `UD21x18` is `uint128`.

Depending on how you receive payments, you have to calculate the rate per second and scale its value to 18 decimals
format as below:

1. Based on a duration, e.g., 3 months
2. Between two points in time, e.g., January 1, 2025 to April, 1 2025

The calculation method is the same in either case.

## Set up a library

Declare the Solidity version used to compile the library:

<CodeBlock language="solidity" metastring={`reference title=""`}>
  {`https://github.com/sablier-labs/evm-examples/blob/main/flow/FlowUtilities.sol#L2`}
</CodeBlock>

Import the relevant symbols:

<CodeBlock language="solidity" metastring={`reference title=""`}>
  {`https://github.com/sablier-labs/evm-examples/blob/main/flow/FlowUtilities.sol#L4-L5`}
</CodeBlock>

Declare a library that can be used in other contracts:

<CodeBlock language="solidity" metastring={`reference title=""`}>
  {`https://github.com/sablier-labs/evm-examples/blob/main/flow/FlowUtilities.sol#L8`}
</CodeBlock>

## Calculate the rate per second on a duration

Define a function called `ratePerSecondWithDuration` that takes the following parameters and the returned value:

<CodeBlock language="solidity" metastring={`reference title=""`}>
  {`https://github.com/sablier-labs/evm-examples/blob/main/flow/FlowUtilities.sol#L15-L22`}
</CodeBlock>

First, retrieve the token's decimals. Note that not all ERC-20 tokens use the 18-decimal standard.

<CodeBlock language="solidity" metastring={`reference title=""`}>
  {`https://github.com/sablier-labs/evm-examples/blob/main/flow/FlowUtilities.sol#L25`}
</CodeBlock>

If the token uses 18 decimals, simply divide the amount by the duration:

<CodeBlock language="solidity" metastring={`reference title=""`}>
  {`https://github.com/sablier-labs/evm-examples/blob/main/flow/FlowUtilities.sol#L29-L31`}
</CodeBlock>

If the token has less than 18 decimals, calculate the scale factor from the token's decimals:

<CodeBlock language="solidity" metastring={`reference title=""`}>
  {`https://github.com/sablier-labs/evm-examples/blob/main/flow/FlowUtilities.sol#L34`}
</CodeBlock>

Then, multiply the amount by the scale factor and divide it by the duration:

<CodeBlock language="solidity" metastring={`reference title=""`}>
  {`https://github.com/sablier-labs/evm-examples/blob/main/flow/FlowUtilities.sol#L37`}
</CodeBlock>

## Calculate the rate per second on timestamps

Here, there are two time parameters, a start and an end time, instead of a duration. Let's define the function:

<CodeBlock language="solidity" metastring={`reference title=""`}>
  {`https://github.com/sablier-labs/evm-examples/blob/main/flow/FlowUtilities.sol#L47-L55`}
</CodeBlock>

The first step is to calculate the duration between the two timestamps:

<CodeBlock language="solidity" metastring={`reference title=""`}>
  {`https://github.com/sablier-labs/evm-examples/blob/main/flow/FlowUtilities.sol#L58`}
</CodeBlock>

The remaining logic is identical to the duration-based calculation:

<CodeBlock language="solidity" metastring={`reference title=""`}>
  {`https://github.com/sablier-labs/evm-examples/blob/main/flow/FlowUtilities.sol#L61-L71`}
</CodeBlock>

## Additional utilities

To calculate earnings for specific durations from an existing stream, you can use the following functions:

<CodeBlock language="solidity" metastring={`reference title=""`}>
  {`https://github.com/sablier-labs/evm-examples/blob/main/flow/FlowUtilities.sol#L77-L95`}
</CodeBlock>

## Full code

Below you can see the complete `FlowUtilities` library:

<CodeBlock language="solidity" showLineNumbers metastring={`reference title="Flow Utilities library"`}>
  {`https://github.com/sablier-labs/evm-examples/blob/main/flow/FlowUtilities.sol`}
</CodeBlock>
